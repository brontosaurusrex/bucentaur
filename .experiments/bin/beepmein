#!/bin/bash

# beepmein

# A little wrapper around linux 'at' command, that will beep you at specific time, see --help.
# On Debian systems make sure 'at' is installed with --no-install-recommends.

# config
alarmSample="$HOME/.cache/beepmein/stacy.mp3" # change me

# Will kill all children with 'killall beepmein'
trap 'kill $(jobs -p) >/dev/null 2>&1' EXIT

# required
command -v at >/dev/null 2>&1 || { >&2 echo "I need at: sudo apt install --no-install-recommends at" ; exit 1; }
command -v speaker-test >/dev/null 2>&1 || { >&2 echo "I need speaker-test from alsa-utils (for reminder sound)." ; exit 1; }
command -v notify-send >/dev/null 2>&1 || { >&2 echo "I need notify-send." ; exit 1; }
command -v mpv >/dev/null 2>&1 || { >&2 echo "I need mpv (for alarm sounds)." ; exit 1; }

# help
help () { 
cat << EOF

       beepmein now + 3 minutes 
                ^                
                'at' time format
                
       beepmein 22:10
                ^
                also 'at' time format
                
       beepmein 3
                ^                
                in 3 minutes (beepmein shortcut)
                
       beepmein --alarm 8:00 
                  ^
                  Will play audio sample,
                  that you defined by setting alarmSample.
                  Must be first parameter.
    
       beepmein --test # test beep and notification
       
       # More testing
       beepmein --reaction reminder_text
       beepmein --reaction --alarm alarm_text
       
       killall beepmein # kill all running playback/beeping
                
       # Notes:
       at -l       # will list pending jobs (or atq)
       at -r <num> # will remove job <num>  (or atrm)

EOF
}

# reminder sound, needs speaker-test (alsa-utils)
beep () {
    [ -z "$1" ] && loops="1" || loops="$1"
    for ((i=1; i<=loops; i++))
    do
        timeout -s HUP 0.1 speaker-test -t sine -f 1000  > /dev/null 2>&1
        sleep 0.1
    done
}

# reminder sound 2, needs sox
soxchord () {
    /usr/bin/play -n synth pl G2 pl B2 pl D3 pl G3 pl D4 pl G4 \
    delay 0 .05 .1 .15 .2 .25 remix - fade 0 4 .1 norm -1 > /dev/null 2>&1
}

# alarm failsafe (by misko), this will be used if 'alarmSample' is not found.
alarmfailsafe () {
for ((i=1; i<=10; i++)); do
      for ((c=1;c<=3;c++)); do
          timeout -s HUP  0.2 speaker-test -t sine -f 3000  > /dev/null 2>&1
          sleep 0.2
       done
       sleep 1
done
}

# test audio and notifications
test () {
    echo "notify test"
    notify-send "notify test" || echo "failed"
    echo
    echo "internal beep test used for reminders"
    soxchord || echo "failed"
    echo
    echo "failsafe internal beep test used for reminders"
    beep "3" || echo "failed"
    echo
    echo "mpv sample test used for alarms"
    mpv --no-resume-playback --no-video --length=10 "$alarmSample" || echo "failed"
    echo "failsafe internal beep test used for alarms"
    alarmfailsafe || echo "failed"
    echo
}

# help or test
if [ "$1" == "--help" ] || [ "$1" == "-h" ] || [ $# -eq 0 ]; then
    help; exit
elif [ "$1" == "--test" ]; then
    test; exit
fi

# main
if [ "$1" != "--reaction" ] ; then
    if [ "$1" == "--alarm" ] ; then
        [[ -f "$alarmSample" ]] || { >&2 printf "Note: alarmSample %s not found, \nyou may want to configure the script. \nInternal fail-safe beep will be used instead.\n" "$alarmSample"; }
        alarm="--alarm" && shift
    fi
    # input
    attime="$*" #concat
    # special case for minutes
    if [[ $attime == ?(-)+([0-9]) ]] ; then # is integer
        attime="now + $attime minutes"
    fi
    read -rp "reason? " reason
    #reason="$(printf "$(yad --separator="" --form --field 'reason?':TXT)\n")"
    [[ -z "$reason" ]] && reason="beep beep beep"
    echo "beepmein: $attime, reason: $reason"
    # set 'at'
    at "$attime" <<< "$(echo "beepmein --reaction $alarm '${reason}'")" > /dev/null 2>&1
else
    # reaction
    shift
    if [ "$1" == "--alarm" ]; then
        shift
        notify-send "$1" &
        mpv --no-resume-playback --no-video "$alarmSample" || alarmfailsafe
    else
        notify-send "$1" &
        soxchord || beep "3"
    fi
fi
