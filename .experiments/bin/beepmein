#!/bin/bash

# beepmein

# a little wrapper around linux 'at' command, that will beep you at specific time, see --help.

# config
alarmSample="$HOME/data/music/AC-DC/CD 1/01. Thunderstruck.mp3"
# mpv --no-resume-playback "$alarmSample" && exit # debug

# required
command -v at >/dev/null 2>&1 || { >&2 echo "I need at." ; exit 1; }
command -v speaker-test >/dev/null 2>&1 || { >&2 echo "I need speaker-test from alsa-utils (for reminder sound)." ; exit 1; }
command -v notify-send >/dev/null 2>&1 || { >&2 echo "I need notify-send." ; exit 1; }
command -v mpv >/dev/null 2>&1 || { >&2 echo "I need mpv (for alarm sounds)." ; exit 1; }

# help
help () { 
cat << EOF

       beepmein now + 3 minutes 
                ^                
                'at' time format
                
       beepmein 22:10
                ^
                also 'at' time format
                
       beepmein 3
                ^                
                in 3 minutes (beepmein shortcut)
                
       beepmein --alarm 8:00 
                  ^
                  Will play (longer) audio sample,
                  that you defined by setting alarmSample.
                  
                  You may want to define a song with some video/coverart,
                  so that some gui will be provided for easier kill or
                  stop with killall mpv
    
       beepmein --test # test beep and notification
       
       # More testing
       beepmein --reaction reminder_text
       beepmein --reaction --alarm alarm_text
       
       beepmein --help # this help
                
       # Notes:
       at -l      # will list pending jobs
       atrm <num> # will remove job <num>

EOF
}

# reminder sound
beep () {
    [ -z "$1" ] && loops="1" || loops="$1"
    for ((i=1; i<=loops; i++))
    do
        timeout -s HUP 0.1 speaker-test -t sine -f 1000  > /dev/null 2>&1
        sleep 0.1
    done
}

# test audio and notifications
test () {
    echo "notify test"
    notify-send "notify test" || echo "failed"
    echo
    echo "internal beep test used for reminders"
    beep "3" || echo "failed"
    echo
    echo "mpv sample test used for alarms"
    mpv --no-resume-playback "$alarmSample" || echo "failed"
}

# help or test
if [ "$1" == "--help" ] || [ "$1" == "-h" ] || [ $# -eq 0 ]; then
    help; exit
elif [ "$1" == "--test" ]; then
    test; exit
fi

# main
if [ "$1" != "--reaction" ] ; then
    if [ "$1" == "--alarm" ] ; then 
        alarm="--alarm" && shift
    fi
    # input
    attime="$*" #concat
    # special case for minutes
    if [[ $attime == ?(-)+([0-9]) ]] ; then # is integer
        attime="now + $attime minutes"
    fi
    read -rp "reason? " reason
    #reason="$(printf "$(yad --separator="" --form --field 'reason?':TXT)\n")"
    [[ -z "$reason" ]] && reason="beep beep beep"
    echo "beepmein: $attime, reason: $reason"
    # set 'at'
    at "$attime" <<< "$(echo "beepmein --reaction '${alarm}' '${reason}'")" > /dev/null 2>&1
else
    # reaction
    shift
    if [ "$1" == "--alarm" ]; then
        notify-send "$2" &
        mpv --no-resume-playback "$alarmSample" # alarm
    else
        beep "3" & notify-send "$1"             # reminder
    fi
fi
