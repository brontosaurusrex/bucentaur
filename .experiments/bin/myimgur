#!/bin/bash

# imgur uploader, markdown && bbcode generator

# PNG files over 5MB will be converted to JPEGs. https://0x0.st/sGED

# imgurl id

# Read id from config
idfile="$HOME/.config/myimgur/id" 
if [ -f "$idfile" ]; then
    while read -r line ; do 
        id="$line"
    done < "$idfile" 
fi
[ -z "$id" ] && id="" # or enter directly
[ -z "$id" ] && { echo "Provide imgur id, https://apidocs.imgur.com/?version=latest" ; exit 1; }

# required
command -v jq >/dev/null 2>&1 || { >&2 echo "I need jq" ; exit 1; }
command -v curl >/dev/null 2>&1 || { >&2 echo "I need curl" ; exit 1; }

# tmpdir
tmp="/tmp/$RANDOM-$$"
trap '[ -n "$tmp" ] && rm -fr "$tmp"' EXIT
mkdir -m 700 "$tmp" || { echo '!! unable to create a tmpdir' >&2; tmp=; exit 1; }

while [ $# -gt 0 ]; do

    # check input file
    [[ -f "$1" ]] || exit 1

    # basename
    name="$(basename "$1")"

    # upload (-sS to reduce verbosity)
    curl --request POST --url https://api.imgur.com/3/image \
    --header "authorization: Client-ID $id" \
    --header 'content-type: multipart/form-data;' \
    -F "image=@$1" -F "name=$name" -F "title=$name" > "$tmp/return.json"

    # get some bash variables from json, requires jq
    link="$( jq -r '.data | .link' < "$tmp/return.json" )"
    deletehash="$( jq -r '.data | .deletehash' < "$tmp/return.json" )"
    #echo "$name $link $deletehash"

    # b=160x160 thumb, l=640x480 medium
    linknoext="${link%.*}"                      # get the filename
    extension="${link##*.}"                     # get the extension
    thumb="${linknoext}b.${extension}"
    medium="${linknoext}l.${extension}"
    
    # weserv proxy https://images.weserv.nl/docs
    prefix="https://images.weserv.nl/?url="
    link="$prefix$link"
    thumb="$prefix$thumb"
    medium="$prefix$medium"

    # markdown medium and thumb
    echo "Markdown"
    echo "[![$name $deletehash th]($thumb)̉]($link)"
    echo "[![$name $deletehash md]($medium)̉]($link)"
    echo "bb"
    #echo "[url=$link][img alt="\"$name $deletehash th\"" title="\"$name\""]${thumb}[/img][/url]"
    #echo "[url=$link][img alt="\"$name $deletehash md\"" title="\"$name\""]${medium}[/img][/url]"
    echo "[url=$link#$deletehash][img]${thumb}[/img][/url]"
    echo "[url=$link#$deletehash][img]${medium}[/img][/url]"
    
shift
done
