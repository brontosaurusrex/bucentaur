#!/bin/bash

# pipeBeepmein
# beepmein pipe menu for jgmenu

# usage: pipeBeepmein | jgmenu --simple --icon-size=0

# required
command -v at >/dev/null 2>&1 || { >&2 echo "I need at: sudo apt install --no-install-recommends at" ; exit 1; }
command -v gmrun >/dev/null 2>&1 || { >&2 echo "I need gmrun." ; exit 1; }
command -v awk >/dev/null 2>&1 || { >&2 echo "I need awk." ; exit 1; }

# for display purposes
future="$(date -d "+5 minutes" +%R)"
echo "^sep(Time is now: $(date +%R))"

# for timeToEvent()
now="$(date +%s)"

# timeToEvent
timeToEvent() {
    # job Event time
    event="$(echo "$1" | cut -d' ' -f 2-6)" # cut instead of awk?
    if [[ "$event" ]]; then

        event="$(date -d "$event" +%s)"
        diff=$(( event - now ))

        # And show as HH:MM:SS, only if less than 24 hours
        # 24 hours is 86400 seconds
        if (( diff < 86400 )); then
            date -u -d @${diff} +%T
        fi
    fi
}

# action
echo "＋ beepmein ~ 1, beepmein 1"
echo "＋ beepmein ~ 5, beepmein 5" 
echo "＋ beepmein ~ 15 (edit), gmrun '"beepmein 15"'"
echo "＋ beepmein $future (edit), gmrun '"beepmein $future"'"
echo "＋ beepmein $future --alarm (edit), gmrun '"beepmein $future --alarm"'"
echo "^sep(Add morning alarm:)"
echo "＋ beepmein 7:00 --alarm (edit), gmrun '"beepmein 7:00 --alarm"'"
echo "＋ beepmein 7:30 --alarm (edit), gmrun '"beepmein 7:30 --alarm"'"

echo "^sep(Test event:)"
echo "▶  reminder, beepmein --reaction reminder"
echo "▶  alarm, beepmein --reaction --alarm alarm"
echo "◼  stop, killall beepmein"

lines="$(atq | wc -l)"
if (( lines > 0 )) ; then

    echo "^sep(Click to remove from queue:)"
    
    # This is the actual line by line loop    
    atq | sort -r | while read -r line ; do
    
        # get diff
        toEvent="$(timeToEvent "$line")"
        [[ "$toEvent" ]] && toEvent="\t&lt; $toEvent"
        
        # awk pain
        echo "$line" | awk -v toEvent="$toEvent" '{printf"✕ "$5" ("$3"-"$4") "}{ if($7 == "\=")
        {printf " \t now"}else{printf toEvent}; print ", atrm " $1}' 2> /dev/null
    
    done
    
fi
